define(["react","big.js","mendix/filters/builders"],(function(e,t,n){"use strict";function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a,r=l(t),i={exports:{}};
/*!
  	Copyright (c) 2018 Jed Watson.
  	Licensed under the MIT License (MIT), see
  	http://jedwatson.github.io/classnames
  */
a=i,function(){var e={}.hasOwnProperty;function t(){for(var n=[],l=0;l<arguments.length;l++){var a=arguments[l];if(a){var r=typeof a;if("string"===r||"number"===r)n.push(a);else if(Array.isArray(a)){if(a.length){var i=t.apply(null,a);i&&n.push(i)}}else if("object"===r){if(a.toString!==Object.prototype.toString&&!a.toString.toString().includes("[native code]")){n.push(a.toString());continue}for(var u in a)e.call(a,u)&&a[u]&&n.push(u)}}}return n.join(" ")}a.exports?(t.default=t,a.exports=t):window.classNames=t}();var u=i.exports;function s(t,n){const[l,a]=e.useState(),r=e.useCallback((()=>{a((e=>{const n=null==t?void 0:t.getBoundingClientRect();return a=n,(l=e)&&a&&l.height===a.height&&l.width===a.width&&l.bottom===a.bottom&&l.top===a.top&&l.left===a.left&&l.right===a.right?e:n;var l,a}))}),[t]);var i;return i=n?r:void 0,e.useEffect((()=>i?function(e){let t;const n=()=>{t=window.requestAnimationFrame((()=>{e(),n()}))},l=()=>window.cancelAnimationFrame(t);return n(),l}(i):void 0),[i]),l}function o(t){const n=t.defaultFilter,l=t.onChange,[a,r]=e.useState(n),[i,o]=e.useState(!1),c=e.useRef(null),d=e.useRef(null);var h,f;h=[c,d],f=()=>o(!1),e.useEffect((()=>{const e=e=>{if(Array.isArray(h)){if(h.some((t=>!t.current||t.current.contains(e.target))))return}else if(!h.current||h.current.contains(e.target))return;f()};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}}),[h,f]);const p=s(c.current,i),v=e.useCallback((e=>{r(e),l(e),o(!1)}),[l]);e.useEffect((()=>{r(n),l(n)}),[n,l]);const m=e.createElement("ul",{ref:d,id:"".concat(t.id,"-filter-selectors"),className:"filter-selectors",role:"menu","data-focusindex":0,style:{position:"fixed",top:null==p?void 0:p.bottom,left:null==p?void 0:p.left}},t.options.map(((n,l)=>e.createElement("li",{className:u({"filter-selected":a===n.value}),key:l,onClick:e=>{e.preventDefault(),e.stopPropagation(),v(n.value)},onKeyDown:e=>{if("Enter"===e.key||" "===e.key)e.preventDefault(),e.stopPropagation(),v(n.value);else if("Tab"===e.key&&l+1===t.options.length)e.preventDefault(),v(a);else if("Tab"===e.key&&e.shiftKey&&0===l||"Escape"===e.key){var r;e.preventDefault(),null===(r=c.current)||void 0===r||null===(r=r.querySelector("button"))||void 0===r||r.focus(),o(!1)}},role:"menuitem",tabIndex:0},e.createElement("div",{className:u("filter-icon",n.value),"aria-hidden":!0}),e.createElement("div",{className:"filter-label"},n.label))))),g=e.useCallback((()=>{o((e=>!e)),setTimeout((()=>{var e;null===(e=d.current)||void 0===e||null===(e=e.querySelector("li.filter-selected"))||void 0===e||e.focus()}),10)}),[]);return e.createElement("div",{className:"filter-selector"},e.createElement("div",{className:"filter-selector-content",ref:c},e.createElement("button",{"aria-controls":"".concat(t.id,"-filter-selectors"),"aria-expanded":i,"aria-haspopup":!0,"aria-label":t.ariaLabel,className:u("btn btn-default filter-selector-button button-icon",a),onClick:g,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),g())}},"Â "),i&&m))}const c=e.memo((function(t){var n;const{current:l}=e.useRef(t.defaultFilter);return e.createElement("div",{className:u("filter-container",t.className),"data-focusindex":null!==(n=t.tabIndex)&&void 0!==n?n:0,style:t.styles},t.adjustable&&e.createElement(o,{ariaLabel:t.screenReaderButtonCaption,id:t.id,defaultFilter:l,onChange:t.onFilterChange,options:t.filters}),e.createElement("input",{"aria-label":t.screenReaderInputCaption,className:u("form-control",{"filter-input":t.adjustable}),disabled:t.inputDisabled,onChange:t.onInputChange,placeholder:t.placeholder,ref:t.inputRef,type:t.inputType,value:t.inputValue}))})),d=Object.freeze({reset:{value:"reset.value",filters:"reset.filters"}});function h(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var l=n.call(e,t||"default");if("object"!=typeof l)return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let f=()=>({emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),l=1;l<t;l++)n[l-1]=arguments[l];for(let t=0,l=this.events[e]||[],a=l.length;t<a;t++)l[t](...n)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var n;this.events[e]=null===(n=this.events[e])||void 0===n?void 0:n.filter((e=>t!==e))}}});const p="com.mendix.widgets.web.plugin.externalEvents";class v{constructor(){h(this,"channels",void 0),h(this,"id",Math.random().toString().slice(2)),this.channels=new Map}disposeChannel(e){const t=this.channels.get(e);return t&&(t.events={}),this.channels.delete(e)}getChannel(e){let t=this.channels.get(e);return t||(t=f(),this.channels.set(e,t),t)}emit(e,t){for(var n,l=arguments.length,a=new Array(l>2?l-2:0),r=2;r<l;r++)a[r-2]=arguments[r];null===(n=this.channels.get(e))||void 0===n||n.emit(t,...a)}subscribe(e,t,n){return this.getChannel(e).on(t,n),()=>this.unsubscribe(e,t,n)}unsubscribe(e,t,n){const l=this.channels.get(e);if(!l)return;const a=l.events[t];a&&(l.events[t]=a.filter((e=>e!==n)));0===Object.values(l.events).flat().reduce(((e,t)=>t?e+1:e),0)&&this.disposeChannel(e)}}function m(){var e,t;return null!==(t=(e=window)[p])&&void 0!==t?t:e[p]=function(){if(Object.prototype.hasOwnProperty.call(window,p))throw new Error("Widget plugin external events: plugin already initialized!");return new v}()}function g(t,n,l){e.useEffect((()=>{if(void 0!==t)return m().subscribe(t,n,l)}),[t,n])}class b{constructor(e){var t;h(this,"clearTimers",void 0),h(this,"valueHelper",void 0),h(this,"filterListener",void 0),h(this,"stateListener",void 0),h(this,"_value",void 0),h(this,"state",void 0),h(this,"dispatchOnMounted",void 0),this._value=e.defaultValue,this.filterListener=e.onFilterChange,this.dispatchOnMounted=e.dispatchOnMounted,this.valueHelper=e.valueHelper,this.state={inputValue:this.valueHelper.toString(e.defaultValue),filterFn:e.defaultFilter},[this.onInputChange,this.clearTimers]=((e,t)=>{let n=null;const l=()=>{null!==n&&(clearTimeout(n),n=null)};return[function(){for(var a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];l(),n=setTimeout((()=>e(...r)),t)},l]})(this.onInputChange.bind(this),null!==(t=e.delay)&&void 0!==t?t:500)}addStateChangeListener(e){this.stateListener=e}dispose(){this.clearTimers(),this.stateListener=void 0,this.filterListener=void 0}set(e,t){return this.state[e]!==t&&(this.state[e]=t,this.dispatchState({...this.state}),!0)}setInputValue(e){this.set("inputValue",e)&&this.onInputChange()}setFilterFn(e){this.set("filterFn",e)&&this.onFilterChange()}dangerous_setValueAndDoNotDispatch(e){return!this.valueHelper.equals(this._value,e)&&(this._value=e,this.set("inputValue",this.valueHelper.toString(e)),!0)}reset(){this.dangerous_setValueAndDoNotDispatch(void 0)&&this.dispatchValue()}setupEffect(){return this.dispatchOnMounted&&this.dispatchValue(),()=>this.dispose()}dispatchState(e){var t;null===(t=this.stateListener)||void 0===t||t.call(this,e)}dispatchValue(){var e;null===(e=this.filterListener)||void 0===e||e.call(this,this._value,this.state.filterFn)}onInputChange(){const e=this.valueHelper.fromString(this.state.inputValue);this.valueHelper.equals(this._value,e)||(this._value=e,this.dispatchValue())}onFilterChange(){this.dispatchValue()}}function y(t){const n=function(t){const n=e.useRef(t);return e.useEffect((()=>{n.current=t})),e.useCallback((function(){for(var e=arguments.length,t=new Array(e),l=0;l<e;l++)t[l]=arguments[l];return n.current&&n.current.apply(void 0,t)}),[])}(t.onFilterChange),l=e.useMemo((()=>new b({...t,onFilterChange:n})),[]),[a,r]=e.useState((()=>(l.addStateChangeListener((e=>r(e))),l.state))),i=e.useMemo((()=>({setInputValue:e=>l.setInputValue(e),setFilterFn:e=>l.setFilterFn(e),dangerous_setValueAndDoNotDispatch:e=>l.dangerous_setValueAndDoNotDispatch(e),reset:()=>l.reset()})),[]);return e.useEffect((()=>l.setupEffect()),[]),[a,i]}function E(t){var n,l;const a=e.useRef(null),r=null!==(n=t.inputDisabled)&&void 0!==n?n:()=>!1,[i,{setFilterFn:u,setInputValue:s,reset:o,dangerous_setValueAndDoNotDispatch:c}]=y({onFilterChange:t.onChange,defaultValue:t.value,defaultFilter:t.defaultFilter,dispatchOnMounted:void 0!==t.value,delay:t.changeDelay,valueHelper:t.valueHelper});return e.useEffect((()=>{c(t.value)}),[t.value]),function(t){let{widgetName:n,parentChannelName:l,listener:a}=t;const{current:r}=e.useRef(a);g(n,d.reset.value,r),g(l,d.reset.value,r)}({widgetName:t.name,parentChannelName:null!==(l=t.parentChannelName)&&void 0!==l?l:void 0,listener:o}),{defaultFilter:t.defaultFilter,filters:t.filters,inputType:t.inputType,inputRef:a,inputValue:i.inputValue,inputDisabled:r(i.filterFn),onFilterChange:e.useCallback((e=>{var t;u(e),null===(t=a.current)||void 0===t||t.focus()}),[]),onInputChange:e.useCallback((e=>s(e.target.value)),[])}}const C={fromString:e=>{try{return new r.default(e)}catch{return}},toString:e=>e?e.toString():"",equals:(e,t)=>e instanceof r.default&&t instanceof r.default?e.eq(t):e===t},w=Object.entries({greater:"Greater than",greaterEqual:"Greater than or equal",equal:"Equal",notEqual:"Not equal",smaller:"Smaller than",smallerEqual:"Smaller than or equal",empty:"Empty",notEmpty:"Not empty"}).map((e=>{let[t,n]=e;return{value:t,label:n}}));function N(t){const{defaultFilter:n,value:l,onChange:a,parentChannelName:r,changeDelay:i,...u}=t,s=E({name:u.name,parentChannelName:r,inputType:"number",inputDisabled:e=>"empty"===e||"notEmpty"===e,changeDelay:i,defaultFilter:n,filters:w,value:l,onChange:a,valueHelper:C});return e.createElement(c,{...u,...s})}const F=t=>{let{className:n,bootstrapStyle:l,children:a,role:r}=t;return e.Children.count(a)>0?e.createElement("div",{className:u("alert alert-".concat(l),n),role:r},a):null};var D;F.displayName="Alert",function(e){e.STRING="string",e.NUMBER="number",e.ENUMERATION="enum",e.DATE="date",e.ASSOCIATION="association"}(D||(D={}));const S="com.mendix.widgets.web.filterable.filterContext";function q(e){if(e&&1===e.length){const[n]=e;let l="equal";switch(n.type){case">":l="greater";break;case">=":l="greaterEqual";break;case"=":l="equal";break;case"!=":l="notEqual";break;case"<":l="smaller";break;case"<=":l="smallerEqual"}if(n.value instanceof t.Big)return{type:l,value:n.value}}}function A(e){if(e)return Object.keys(e).map((t=>e[t])).filter((e=>e.type.match(/AutoNumber|Decimal|Integer|Long/)))}return function(t){const l=e.useRef("NumberFilter".concat(function(){const e="com.mendix.widgets.web.UUID";return window[e]||(window[e]=1),window[e]++}())),a=function(t){const n=e.useRef(null);return"loading"!==(null==t?void 0:t.status)&&null===n.current&&(n.current=null==t?void 0:t.value),n.current}(t.defaultValue),r=window[S],i=e.createElement(F,{bootstrapStyle:"danger"},"The Number filter widget must be placed inside the header of the Data grid 2.0 or Gallery widget."),u=e.createElement(F,{bootstrapStyle:"danger"},'The Number filter widget can\'t be used with the filters options you have selected. It requires a "Autonumber, Decimal, Integer or Long" attribute to be selected.');return(null==r?void 0:r.Consumer)?e.createElement(r.Consumer,null,(r=>{var s,o,c,d,h,f,p;if(!r||!r.filterDispatcher||!r.singleAttribute&&!r.multipleAttributes)return i;const{filterDispatcher:v,singleAttribute:m,multipleAttributes:g,singleInitialFilter:b,multipleInitialFilters:y}=r,E=[...m?[m]:[],...g&&null!==(s=A(g))&&void 0!==s?s:[]];if(0===E.length)return g?u:i;const C=q(b||(null==y?void 0:y[E[0].id])),w=(S=E[0].type)&&!S.match(/AutoNumber|Decimal|Integer|Long/)?"The attribute type being used for Number filter is not 'Autonumber, Decimal, Integer or Long'":null;var S;return w?e.createElement(F,{bootstrapStyle:"danger"},w):null===a?null:e.createElement(N,{name:t.name,parentChannelName:null!==(o=r.eventsChannelName)&&void 0!==o?o:null,adjustable:t.adjustable,className:t.class,defaultFilter:null!==(c=null==C?void 0:C.type)&&void 0!==c?c:t.defaultFilter,value:null!==(d=null==C?void 0:C.value)&&void 0!==d?d:a,changeDelay:t.delay,id:l.current,placeholder:null===(h=t.placeholder)||void 0===h?void 0:h.value,screenReaderButtonCaption:null===(f=t.screenReaderButtonCaption)||void 0===f?void 0:f.value,screenReaderInputCaption:null===(p=t.screenReaderInputCaption)||void 0===p?void 0:p.value,styles:t.style,tabIndex:t.tabIndex,onChange:(e,l)=>{var a,r;null===(a=t.valueAttribute)||void 0===a||a.setValue(e),null===(r=t.onChange)||void 0===r||r.execute();const i=null==E?void 0:E.map((t=>function(e,t,l){if(!e||!e.filterable||"empty"!==l&&"notEmpty"!==l&&!t)return;const a={greater:n.greaterThan,greaterEqual:n.greaterThanOrEqual,equal:n.equals,notEqual:n.notEqual,smaller:n.lessThan,smallerEqual:n.lessThanOrEqual,empty:n.equals,notEmpty:n.notEqual};return a[l](n.attribute(e.id),n.literal("empty"===l||"notEmpty"===l?void 0:t))}(t,e,l))).filter((e=>void 0!==e));v({getFilterCondition:()=>i&&i.length>1?n.or(...i):null==i?void 0:i[0],filterType:D.NUMBER})}})})):i}}));
