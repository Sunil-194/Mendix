import{useState as e,useCallback as t,useEffect as n,useRef as r,createElement as i,memo as a,useMemo as l,Children as s}from"react";import"big.js";import{or as u,attribute as o,literal as c,contains as d,startsWith as h,endsWith as p,greaterThan as v,greaterThanOrEqual as f,equals as g,notEqual as m,lessThan as b,lessThanOrEqual as y}from"mendix/filters/builders";var w,C={exports:{}};
/*!
	Copyright (c) 2018 Jed Watson.
	Licensed under the MIT License (MIT), see
	http://jedwatson.github.io/classnames
*/w=C,function(){var e={}.hasOwnProperty;function t(){for(var n=[],r=0;r<arguments.length;r++){var i=arguments[r];if(i){var a=typeof i;if("string"===a||"number"===a)n.push(i);else if(Array.isArray(i)){if(i.length){var l=t.apply(null,i);l&&n.push(l)}}else if("object"===a){if(i.toString!==Object.prototype.toString&&!i.toString.toString().includes("[native code]")){n.push(i.toString());continue}for(var s in i)e.call(i,s)&&i[s]&&n.push(s)}}}return n.join(" ")}w.exports?(t.default=t,w.exports=t):window.classNames=t}();var F=C.exports;function N(r,i){const[a,l]=e(),s=t((()=>{l((e=>{const t=null==r?void 0:r.getBoundingClientRect();return i=t,(n=e)&&i&&n.height===i.height&&n.width===i.width&&n.bottom===i.bottom&&n.top===i.top&&n.left===i.left&&n.right===i.right?e:t;var n,i}))}),[r]);var u;return n((()=>u?function(e){let t;const n=()=>{t=window.requestAnimationFrame((()=>{e(),n()}))},r=()=>window.cancelAnimationFrame(t);return n(),r}(u):void 0),[u=i?s:void 0]),a}function S(a){const l=a.defaultFilter,s=a.onChange,[u,o]=e(l),[c,d]=e(!1),h=r(null),p=r(null);var v,f;n((()=>{const e=e=>{if(Array.isArray(v)){if(v.some((t=>!t.current||t.current.contains(e.target))))return}else if(!v.current||v.current.contains(e.target))return;f()};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}}),[v=[h,p],f=()=>d(!1)]);const g=N(h.current,c),m=t((e=>{o(e),s(e),d(!1)}),[s]);n((()=>{o(l),s(l)}),[l,s]);const b=i("ul",{ref:p,id:"".concat(a.id,"-filter-selectors"),className:"filter-selectors",role:"menu","data-focusindex":0,style:{position:"fixed",top:null==g?void 0:g.bottom,left:null==g?void 0:g.left}},a.options.map(((e,t)=>i("li",{className:F({"filter-selected":u===e.value}),key:t,onClick:t=>{t.preventDefault(),t.stopPropagation(),m(e.value)},onKeyDown:n=>{if("Enter"===n.key||" "===n.key)n.preventDefault(),n.stopPropagation(),m(e.value);else if("Tab"===n.key&&t+1===a.options.length)n.preventDefault(),m(u);else if("Tab"===n.key&&n.shiftKey&&0===t||"Escape"===n.key){var r;n.preventDefault(),null===(r=h.current)||void 0===r||null===(r=r.querySelector("button"))||void 0===r||r.focus(),d(!1)}},role:"menuitem",tabIndex:0},i("div",{className:F("filter-icon",e.value),"aria-hidden":!0}),i("div",{className:"filter-label"},e.label))))),y=t((()=>{d((e=>!e)),setTimeout((()=>{var e;null===(e=p.current)||void 0===e||null===(e=e.querySelector("li.filter-selected"))||void 0===e||e.focus()}),10)}),[]);return i("div",{className:"filter-selector"},i("div",{className:"filter-selector-content",ref:h},i("button",{"aria-controls":"".concat(a.id,"-filter-selectors"),"aria-expanded":c,"aria-haspopup":!0,"aria-label":a.ariaLabel,className:F("btn btn-default filter-selector-button button-icon",u),onClick:y,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),y())}},"Â "),c&&b))}const E=a((function(e){var t;const{current:n}=r(e.defaultFilter);return i("div",{className:F("filter-container",e.className),"data-focusindex":null!==(t=e.tabIndex)&&void 0!==t?t:0,style:e.styles},e.adjustable&&i(S,{ariaLabel:e.screenReaderButtonCaption,id:e.id,defaultFilter:n,onChange:e.onFilterChange,options:e.filters}),i("input",{"aria-label":e.screenReaderInputCaption,className:F("form-control",{"filter-input":e.adjustable}),disabled:e.inputDisabled,onChange:e.onInputChange,placeholder:e.placeholder,ref:e.inputRef,type:e.inputType,value:e.inputValue}))})),D=Object.freeze({reset:{value:"reset.value",filters:"reset.filters"}});function x(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let I=()=>({emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(let t=0,r=this.events[e]||[],i=r.length;t<i;t++)r[t](...n)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var n;this.events[e]=null===(n=this.events[e])||void 0===n?void 0:n.filter((e=>t!==e))}}});const T="com.mendix.widgets.web.plugin.externalEvents";class V{constructor(){x(this,"channels",void 0),x(this,"id",Math.random().toString().slice(2)),this.channels=new Map}disposeChannel(e){const t=this.channels.get(e);return t&&(t.events={}),this.channels.delete(e)}getChannel(e){let t=this.channels.get(e);return t||(t=I(),this.channels.set(e,t),t)}emit(e,t){for(var n,r=arguments.length,i=new Array(r>2?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];null===(n=this.channels.get(e))||void 0===n||n.emit(t,...i)}subscribe(e,t,n){return this.getChannel(e).on(t,n),()=>this.unsubscribe(e,t,n)}unsubscribe(e,t,n){const r=this.channels.get(e);if(!r)return;const i=r.events[t];i&&(r.events[t]=i.filter((e=>e!==n)));0===Object.values(r.events).flat().reduce(((e,t)=>t?e+1:e),0)&&this.disposeChannel(e)}}function A(){var e,t;return null!==(t=(e=window)[T])&&void 0!==t?t:e[T]=function(){if(Object.prototype.hasOwnProperty.call(window,T))throw new Error("Widget plugin external events: plugin already initialized!");return new V}()}function q(e,t,r){n((()=>{if(void 0!==e)return A().subscribe(e,t,r)}),[e,t])}class k{constructor(e){var t;x(this,"clearTimers",void 0),x(this,"valueHelper",void 0),x(this,"filterListener",void 0),x(this,"stateListener",void 0),x(this,"_value",void 0),x(this,"state",void 0),x(this,"dispatchOnMounted",void 0),this._value=e.defaultValue,this.filterListener=e.onFilterChange,this.dispatchOnMounted=e.dispatchOnMounted,this.valueHelper=e.valueHelper,this.state={inputValue:this.valueHelper.toString(e.defaultValue),filterFn:e.defaultFilter},[this.onInputChange,this.clearTimers]=((e,t)=>{let n=null;const r=()=>{null!==n&&(clearTimeout(n),n=null)};return[function(){for(var i=arguments.length,a=new Array(i),l=0;l<i;l++)a[l]=arguments[l];r(),n=setTimeout((()=>e(...a)),t)},r]})(this.onInputChange.bind(this),null!==(t=e.delay)&&void 0!==t?t:500)}addStateChangeListener(e){this.stateListener=e}dispose(){this.clearTimers(),this.stateListener=void 0,this.filterListener=void 0}set(e,t){return this.state[e]!==t&&(this.state[e]=t,this.dispatchState({...this.state}),!0)}setInputValue(e){this.set("inputValue",e)&&this.onInputChange()}setFilterFn(e){this.set("filterFn",e)&&this.onFilterChange()}dangerous_setValueAndDoNotDispatch(e){return!this.valueHelper.equals(this._value,e)&&(this._value=e,this.set("inputValue",this.valueHelper.toString(e)),!0)}reset(){this.dangerous_setValueAndDoNotDispatch(void 0)&&this.dispatchValue()}setupEffect(){return this.dispatchOnMounted&&this.dispatchValue(),()=>this.dispose()}dispatchState(e){var t;null===(t=this.stateListener)||void 0===t||t.call(this,e)}dispatchValue(){var e;null===(e=this.filterListener)||void 0===e||e.call(this,this._value,this.state.filterFn)}onInputChange(){const e=this.valueHelper.fromString(this.state.inputValue);this.valueHelper.equals(this._value,e)||(this._value=e,this.dispatchValue())}onFilterChange(){this.dispatchValue()}}function O(i){const a=function(e){const i=r(e);return n((()=>{i.current=e})),t((function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.current&&i.current.apply(void 0,t)}),[])}(i.onFilterChange),s=l((()=>new k({...i,onFilterChange:a})),[]),[u,o]=e((()=>(s.addStateChangeListener((e=>o(e))),s.state))),c=l((()=>({setInputValue:e=>s.setInputValue(e),setFilterFn:e=>s.setFilterFn(e),dangerous_setValueAndDoNotDispatch:e=>s.dangerous_setValueAndDoNotDispatch(e),reset:()=>s.reset()})),[]);return n((()=>s.setupEffect()),[]),[u,c]}function j(e){var i,a;const l=r(null),s=null!==(i=e.inputDisabled)&&void 0!==i?i:()=>!1,[u,{setFilterFn:o,setInputValue:c,reset:d,dangerous_setValueAndDoNotDispatch:h}]=O({onFilterChange:e.onChange,defaultValue:e.value,defaultFilter:e.defaultFilter,dispatchOnMounted:void 0!==e.value,delay:e.changeDelay,valueHelper:e.valueHelper});return n((()=>{h(e.value)}),[e.value]),function(e){let{widgetName:t,parentChannelName:n,listener:i}=e;const{current:a}=r(i);q(t,D.reset.value,a),q(n,D.reset.value,a)}({widgetName:e.name,parentChannelName:null!==(a=e.parentChannelName)&&void 0!==a?a:void 0,listener:d}),{defaultFilter:e.defaultFilter,filters:e.filters,inputType:e.inputType,inputRef:l,inputValue:u.inputValue,inputDisabled:s(u.filterFn),onFilterChange:t((e=>{var t;o(e),null===(t=l.current)||void 0===t||t.focus()}),[]),onInputChange:t((e=>c(e.target.value)),[])}}const L={fromString:e=>e,toString:e=>null!=e?e:"",equals:(e,t)=>e===t},H=Object.entries({contains:"Contains",startsWith:"Starts with",endsWith:"Ends with",greater:"Greater than",greaterEqual:"Greater than or equal",equal:"Equal",notEqual:"Not equal",smaller:"Smaller than",smallerEqual:"Smaller than or equal",empty:"Empty",notEmpty:"Not empty"}).map((e=>{let[t,n]=e;return{value:t,label:n}}));function R(e){const{defaultFilter:t,value:n,onChange:r,parentChannelName:a,changeDelay:l,...s}=e,u=j({name:s.name,parentChannelName:a,inputType:"text",inputDisabled:e=>"empty"===e||"notEmpty"===e,changeDelay:l,defaultFilter:t,filters:H,value:n,onChange:r,valueHelper:L});return i(E,{...s,...u})}const _=e=>{let{className:t,bootstrapStyle:n,children:r,role:a}=e;return s.count(r)>0?i("div",{className:F("alert alert-".concat(n),t),role:a},r):null};var M;_.displayName="Alert",function(e){e.STRING="string",e.NUMBER="number",e.ENUMERATION="enum",e.DATE="date",e.ASSOCIATION="association"}(M||(M={}));const P="com.mendix.widgets.web.filterable.filterContext";function W(e){if(e&&1===e.length){const[t]=e;let n="equal";switch(t.type){case"contains":n="contains";break;case"starts-with":n="startsWith";break;case"ends-with":n="endsWith";break;case">":n="greater";break;case">=":n="greaterEqual";break;case"=":n="equal";break;case"!=":n="notEqual";break;case"<":n="smaller";break;case"<=":n="smallerEqual"}return{type:n,value:String(t.value)}}}function B(e){const t=r("TextFilter".concat(function(){const e="com.mendix.widgets.web.UUID";return window[e]||(window[e]=1),window[e]++}())),n=function(e){const t=r(null);return"loading"!==(null==e?void 0:e.status)&&null===t.current&&(t.current=null==e?void 0:e.value),t.current}(e.defaultValue),a=window[P],l=i(_,{bootstrapStyle:"danger"},"The Text filter widget must be placed inside the header of the Data grid 2.0 or Gallery widget."),s=i(_,{bootstrapStyle:"danger"},'The Text filter widget can\'t be used with the filters options you have selected. It requires a "Hashed string or String" attribute to be selected.');return(null==a?void 0:a.Consumer)?i(a.Consumer,null,(r=>{var a,o,c,d,h,p,v;if(!r||!r.filterDispatcher||!r.singleAttribute&&!r.multipleAttributes)return l;const{filterDispatcher:f,singleAttribute:g,multipleAttributes:m,singleInitialFilter:b,multipleInitialFilters:y}=r,w=[...g?[g]:[],...m&&null!==(a=G(m))&&void 0!==a?a:[]];if(0===w.length)return m?s:l;const C=W(b||(null==y?void 0:y[w[0].id])),F=(N=w[0].type)&&!N.match(/HashString|String/)?"The attribute type being used for Text filter is not 'Hashed string or String'":null;var N;return F?i(_,{bootstrapStyle:"danger"},F):null===n?null:i(R,{adjustable:e.adjustable,className:e.class,defaultFilter:null!==(o=null==C?void 0:C.type)&&void 0!==o?o:e.defaultFilter,value:null!==(c=null==C?void 0:C.value)&&void 0!==c?c:n,changeDelay:e.delay,id:t.current,placeholder:null===(d=e.placeholder)||void 0===d?void 0:d.value,screenReaderButtonCaption:null===(h=e.screenReaderButtonCaption)||void 0===h?void 0:h.value,screenReaderInputCaption:null===(p=e.screenReaderInputCaption)||void 0===p?void 0:p.value,styles:e.style,tabIndex:e.tabIndex,parentChannelName:null!==(v=r.eventsChannelName)&&void 0!==v?v:null,name:e.name,onChange:(t,n)=>{var r,i;null===(r=e.valueAttribute)||void 0===r||r.setValue(t),null===(i=e.onChange)||void 0===i||i.execute();const a=null==w?void 0:w.map((e=>U(e,t,n))).filter((e=>void 0!==e));f({getFilterCondition:()=>a&&a.length>1?u(...a):null==a?void 0:a[0],filterType:M.STRING})}})})):l}function G(e){if(e)return Object.keys(e).map((t=>e[t])).filter((e=>e.type.match(/HashString|String/)))}function U(e,t,n){if(!e||!e.filterable||"empty"!==n&&"notEmpty"!==n&&!t)return;return{contains:d,startsWith:h,endsWith:p,greater:v,greaterEqual:f,equal:g,notEqual:m,smaller:b,smallerEqual:y,empty:g,notEmpty:m}[n](o(e.id),c("empty"===n||"notEmpty"===n?void 0:t))}export{B as default};
