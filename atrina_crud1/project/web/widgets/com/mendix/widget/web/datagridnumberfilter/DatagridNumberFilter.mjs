import{useState as e,useCallback as t,useEffect as n,useRef as r,createElement as l,memo as a,useMemo as i,Children as s}from"react";import u,{Big as o}from"big.js";import{or as c,attribute as d,literal as h,greaterThan as p,greaterThanOrEqual as v,equals as f,notEqual as m,lessThan as g,lessThanOrEqual as b}from"mendix/filters/builders";var y,w={exports:{}};
/*!
	Copyright (c) 2018 Jed Watson.
	Licensed under the MIT License (MIT), see
	http://jedwatson.github.io/classnames
*/y=w,function(){var e={}.hasOwnProperty;function t(){for(var n=[],r=0;r<arguments.length;r++){var l=arguments[r];if(l){var a=typeof l;if("string"===a||"number"===a)n.push(l);else if(Array.isArray(l)){if(l.length){var i=t.apply(null,l);i&&n.push(i)}}else if("object"===a){if(l.toString!==Object.prototype.toString&&!l.toString.toString().includes("[native code]")){n.push(l.toString());continue}for(var s in l)e.call(l,s)&&l[s]&&n.push(s)}}}return n.join(" ")}y.exports?(t.default=t,y.exports=t):window.classNames=t}();var C=w.exports;function N(r,l){const[a,i]=e(),s=t((()=>{i((e=>{const t=null==r?void 0:r.getBoundingClientRect();return l=t,(n=e)&&l&&n.height===l.height&&n.width===l.width&&n.bottom===l.bottom&&n.top===l.top&&n.left===l.left&&n.right===l.right?e:t;var n,l}))}),[r]);var u;return n((()=>u?function(e){let t;const n=()=>{t=window.requestAnimationFrame((()=>{e(),n()}))},r=()=>window.cancelAnimationFrame(t);return n(),r}(u):void 0),[u=l?s:void 0]),a}function F(a){const i=a.defaultFilter,s=a.onChange,[u,o]=e(i),[c,d]=e(!1),h=r(null),p=r(null);var v,f;n((()=>{const e=e=>{if(Array.isArray(v)){if(v.some((t=>!t.current||t.current.contains(e.target))))return}else if(!v.current||v.current.contains(e.target))return;f()};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}}),[v=[h,p],f=()=>d(!1)]);const m=N(h.current,c),g=t((e=>{o(e),s(e),d(!1)}),[s]);n((()=>{o(i),s(i)}),[i,s]);const b=l("ul",{ref:p,id:"".concat(a.id,"-filter-selectors"),className:"filter-selectors",role:"menu","data-focusindex":0,style:{position:"fixed",top:null==m?void 0:m.bottom,left:null==m?void 0:m.left}},a.options.map(((e,t)=>l("li",{className:C({"filter-selected":u===e.value}),key:t,onClick:t=>{t.preventDefault(),t.stopPropagation(),g(e.value)},onKeyDown:n=>{if("Enter"===n.key||" "===n.key)n.preventDefault(),n.stopPropagation(),g(e.value);else if("Tab"===n.key&&t+1===a.options.length)n.preventDefault(),g(u);else if("Tab"===n.key&&n.shiftKey&&0===t||"Escape"===n.key){var r;n.preventDefault(),null===(r=h.current)||void 0===r||null===(r=r.querySelector("button"))||void 0===r||r.focus(),d(!1)}},role:"menuitem",tabIndex:0},l("div",{className:C("filter-icon",e.value),"aria-hidden":!0}),l("div",{className:"filter-label"},e.label))))),y=t((()=>{d((e=>!e)),setTimeout((()=>{var e;null===(e=p.current)||void 0===e||null===(e=e.querySelector("li.filter-selected"))||void 0===e||e.focus()}),10)}),[]);return l("div",{className:"filter-selector"},l("div",{className:"filter-selector-content",ref:h},l("button",{"aria-controls":"".concat(a.id,"-filter-selectors"),"aria-expanded":c,"aria-haspopup":!0,"aria-label":a.ariaLabel,className:C("btn btn-default filter-selector-button button-icon",u),onClick:y,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),y())}},"Â "),c&&b))}const D=a((function(e){var t;const{current:n}=r(e.defaultFilter);return l("div",{className:C("filter-container",e.className),"data-focusindex":null!==(t=e.tabIndex)&&void 0!==t?t:0,style:e.styles},e.adjustable&&l(F,{ariaLabel:e.screenReaderButtonCaption,id:e.id,defaultFilter:n,onChange:e.onFilterChange,options:e.filters}),l("input",{"aria-label":e.screenReaderInputCaption,className:C("form-control",{"filter-input":e.adjustable}),disabled:e.inputDisabled,onChange:e.onInputChange,placeholder:e.placeholder,ref:e.inputRef,type:e.inputType,value:e.inputValue}))})),E=Object.freeze({reset:{value:"reset.value",filters:"reset.filters"}});function S(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let A=()=>({emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(let t=0,r=this.events[e]||[],l=r.length;t<l;t++)r[t](...n)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var n;this.events[e]=null===(n=this.events[e])||void 0===n?void 0:n.filter((e=>t!==e))}}});const I="com.mendix.widgets.web.plugin.externalEvents";class V{constructor(){S(this,"channels",void 0),S(this,"id",Math.random().toString().slice(2)),this.channels=new Map}disposeChannel(e){const t=this.channels.get(e);return t&&(t.events={}),this.channels.delete(e)}getChannel(e){let t=this.channels.get(e);return t||(t=A(),this.channels.set(e,t),t)}emit(e,t){for(var n,r=arguments.length,l=new Array(r>2?r-2:0),a=2;a<r;a++)l[a-2]=arguments[a];null===(n=this.channels.get(e))||void 0===n||n.emit(t,...l)}subscribe(e,t,n){return this.getChannel(e).on(t,n),()=>this.unsubscribe(e,t,n)}unsubscribe(e,t,n){const r=this.channels.get(e);if(!r)return;const l=r.events[t];l&&(r.events[t]=l.filter((e=>e!==n)));0===Object.values(r.events).flat().reduce(((e,t)=>t?e+1:e),0)&&this.disposeChannel(e)}}function q(){var e,t;return null!==(t=(e=window)[I])&&void 0!==t?t:e[I]=function(){if(Object.prototype.hasOwnProperty.call(window,I))throw new Error("Widget plugin external events: plugin already initialized!");return new V}()}function x(e,t,r){n((()=>{if(void 0!==e)return q().subscribe(e,t,r)}),[e,t])}class T{constructor(e){var t;S(this,"clearTimers",void 0),S(this,"valueHelper",void 0),S(this,"filterListener",void 0),S(this,"stateListener",void 0),S(this,"_value",void 0),S(this,"state",void 0),S(this,"dispatchOnMounted",void 0),this._value=e.defaultValue,this.filterListener=e.onFilterChange,this.dispatchOnMounted=e.dispatchOnMounted,this.valueHelper=e.valueHelper,this.state={inputValue:this.valueHelper.toString(e.defaultValue),filterFn:e.defaultFilter},[this.onInputChange,this.clearTimers]=((e,t)=>{let n=null;const r=()=>{null!==n&&(clearTimeout(n),n=null)};return[function(){for(var l=arguments.length,a=new Array(l),i=0;i<l;i++)a[i]=arguments[i];r(),n=setTimeout((()=>e(...a)),t)},r]})(this.onInputChange.bind(this),null!==(t=e.delay)&&void 0!==t?t:500)}addStateChangeListener(e){this.stateListener=e}dispose(){this.clearTimers(),this.stateListener=void 0,this.filterListener=void 0}set(e,t){return this.state[e]!==t&&(this.state[e]=t,this.dispatchState({...this.state}),!0)}setInputValue(e){this.set("inputValue",e)&&this.onInputChange()}setFilterFn(e){this.set("filterFn",e)&&this.onFilterChange()}dangerous_setValueAndDoNotDispatch(e){return!this.valueHelper.equals(this._value,e)&&(this._value=e,this.set("inputValue",this.valueHelper.toString(e)),!0)}reset(){this.dangerous_setValueAndDoNotDispatch(void 0)&&this.dispatchValue()}setupEffect(){return this.dispatchOnMounted&&this.dispatchValue(),()=>this.dispose()}dispatchState(e){var t;null===(t=this.stateListener)||void 0===t||t.call(this,e)}dispatchValue(){var e;null===(e=this.filterListener)||void 0===e||e.call(this,this._value,this.state.filterFn)}onInputChange(){const e=this.valueHelper.fromString(this.state.inputValue);this.valueHelper.equals(this._value,e)||(this._value=e,this.dispatchValue())}onFilterChange(){this.dispatchValue()}}function L(l){const a=function(e){const l=r(e);return n((()=>{l.current=e})),t((function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return l.current&&l.current.apply(void 0,t)}),[])}(l.onFilterChange),s=i((()=>new T({...l,onFilterChange:a})),[]),[u,o]=e((()=>(s.addStateChangeListener((e=>o(e))),s.state))),c=i((()=>({setInputValue:e=>s.setInputValue(e),setFilterFn:e=>s.setFilterFn(e),dangerous_setValueAndDoNotDispatch:e=>s.dangerous_setValueAndDoNotDispatch(e),reset:()=>s.reset()})),[]);return n((()=>s.setupEffect()),[]),[u,c]}function O(e){var l,a;const i=r(null),s=null!==(l=e.inputDisabled)&&void 0!==l?l:()=>!1,[u,{setFilterFn:o,setInputValue:c,reset:d,dangerous_setValueAndDoNotDispatch:h}]=L({onFilterChange:e.onChange,defaultValue:e.value,defaultFilter:e.defaultFilter,dispatchOnMounted:void 0!==e.value,delay:e.changeDelay,valueHelper:e.valueHelper});return n((()=>{h(e.value)}),[e.value]),function(e){let{widgetName:t,parentChannelName:n,listener:l}=e;const{current:a}=r(l);x(t,E.reset.value,a),x(n,E.reset.value,a)}({widgetName:e.name,parentChannelName:null!==(a=e.parentChannelName)&&void 0!==a?a:void 0,listener:d}),{defaultFilter:e.defaultFilter,filters:e.filters,inputType:e.inputType,inputRef:i,inputValue:u.inputValue,inputDisabled:s(u.filterFn),onFilterChange:t((e=>{var t;o(e),null===(t=i.current)||void 0===t||t.focus()}),[]),onInputChange:t((e=>c(e.target.value)),[])}}const j={fromString:e=>{try{return new u(e)}catch{return}},toString:e=>e?e.toString():"",equals:(e,t)=>e instanceof u&&t instanceof u?e.eq(t):e===t},k=Object.entries({greater:"Greater than",greaterEqual:"Greater than or equal",equal:"Equal",notEqual:"Not equal",smaller:"Smaller than",smallerEqual:"Smaller than or equal",empty:"Empty",notEmpty:"Not empty"}).map((e=>{let[t,n]=e;return{value:t,label:n}}));function R(e){const{defaultFilter:t,value:n,onChange:r,parentChannelName:a,changeDelay:i,...s}=e,u=O({name:s.name,parentChannelName:a,inputType:"number",inputDisabled:e=>"empty"===e||"notEmpty"===e,changeDelay:i,defaultFilter:t,filters:k,value:n,onChange:r,valueHelper:j});return l(D,{...s,...u})}const _=e=>{let{className:t,bootstrapStyle:n,children:r,role:a}=e;return s.count(r)>0?l("div",{className:C("alert alert-".concat(n),t),role:a},r):null};var H;_.displayName="Alert",function(e){e.STRING="string",e.NUMBER="number",e.ENUMERATION="enum",e.DATE="date",e.ASSOCIATION="association"}(H||(H={}));const M="com.mendix.widgets.web.filterable.filterContext";function P(e){if(e&&1===e.length){const[t]=e;let n="equal";switch(t.type){case">":n="greater";break;case">=":n="greaterEqual";break;case"=":n="equal";break;case"!=":n="notEqual";break;case"<":n="smaller";break;case"<=":n="smallerEqual"}if(t.value instanceof o)return{type:n,value:t.value}}}function B(e){const t=r("NumberFilter".concat(function(){const e="com.mendix.widgets.web.UUID";return window[e]||(window[e]=1),window[e]++}())),n=function(e){const t=r(null);return"loading"!==(null==e?void 0:e.status)&&null===t.current&&(t.current=null==e?void 0:e.value),t.current}(e.defaultValue),a=window[M],i=l(_,{bootstrapStyle:"danger"},"The Number filter widget must be placed inside the header of the Data grid 2.0 or Gallery widget."),s=l(_,{bootstrapStyle:"danger"},'The Number filter widget can\'t be used with the filters options you have selected. It requires a "Autonumber, Decimal, Integer or Long" attribute to be selected.');return(null==a?void 0:a.Consumer)?l(a.Consumer,null,(r=>{var a,u,o,d,h,p,v;if(!r||!r.filterDispatcher||!r.singleAttribute&&!r.multipleAttributes)return i;const{filterDispatcher:f,singleAttribute:m,multipleAttributes:g,singleInitialFilter:b,multipleInitialFilters:y}=r,w=[...m?[m]:[],...g&&null!==(a=U(g))&&void 0!==a?a:[]];if(0===w.length)return g?s:i;const C=P(b||(null==y?void 0:y[w[0].id])),N=(F=w[0].type)&&!F.match(/AutoNumber|Decimal|Integer|Long/)?"The attribute type being used for Number filter is not 'Autonumber, Decimal, Integer or Long'":null;var F;return N?l(_,{bootstrapStyle:"danger"},N):null===n?null:l(R,{name:e.name,parentChannelName:null!==(u=r.eventsChannelName)&&void 0!==u?u:null,adjustable:e.adjustable,className:e.class,defaultFilter:null!==(o=null==C?void 0:C.type)&&void 0!==o?o:e.defaultFilter,value:null!==(d=null==C?void 0:C.value)&&void 0!==d?d:n,changeDelay:e.delay,id:t.current,placeholder:null===(h=e.placeholder)||void 0===h?void 0:h.value,screenReaderButtonCaption:null===(p=e.screenReaderButtonCaption)||void 0===p?void 0:p.value,screenReaderInputCaption:null===(v=e.screenReaderInputCaption)||void 0===v?void 0:v.value,styles:e.style,tabIndex:e.tabIndex,onChange:(t,n)=>{var r,l;null===(r=e.valueAttribute)||void 0===r||r.setValue(t),null===(l=e.onChange)||void 0===l||l.execute();const a=null==w?void 0:w.map((e=>G(e,t,n))).filter((e=>void 0!==e));f({getFilterCondition:()=>a&&a.length>1?c(...a):null==a?void 0:a[0],filterType:H.NUMBER})}})})):i}function U(e){if(e)return Object.keys(e).map((t=>e[t])).filter((e=>e.type.match(/AutoNumber|Decimal|Integer|Long/)))}function G(e,t,n){if(!e||!e.filterable||"empty"!==n&&"notEmpty"!==n&&!t)return;return{greater:p,greaterEqual:v,equal:f,notEqual:m,smaller:g,smallerEqual:b,empty:f,notEmpty:m}[n](d(e.id),h("empty"===n||"notEmpty"===n?void 0:t))}export{B as default};
